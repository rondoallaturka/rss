<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latinometrics RSS Widget</title>
    
    <!-- Google Fonts with fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Lexend+Deca:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Inline critical CSS to avoid CDN dependency issues -->
    <style>
        /* Critical CSS - No external dependencies */
        .lm-container {
            font-family: 'Lexend Deca', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FCF5ED;
            min-height: 100vh;
        }
        
        .lm-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .lm-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1200px) {
            .lm-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .lm-card {
            background: #EFEAE4;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .lm-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .lm-image {
            width: 100%;
            height: 192px;
            object-fit: cover;
            aspect-ratio: 1;
        }
        
        .lm-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .lm-title {
            font-family: 'Lora', Georgia, serif;
            font-weight: 600;
            font-size: 20px;
            line-height: 1.3;
            color: #222222;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .lm-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 400;
        }
        
        .lm-description {
            font-size: 14px;
            line-height: 1.5;
            color: #444;
            margin-bottom: 16px;
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .lm-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #384F7F;
            color: #FCF5ED;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            min-height: 44px;
            align-self: flex-start;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        .lm-button:hover {
            background: #2a3a5f;
            transform: translateY(-1px);
        }
        
        .lm-premium-overlay {
            width: 100%;
            height: 192px;
            background: linear-gradient(135deg, #384F7F 0%, #384F7F 50%, rgba(56, 79, 127, 0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .lm-premium-content {
            text-align: center;
            color: white;
            z-index: 10;
            position: relative;
        }
        
        .lm-premium-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .lm-premium-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .lm-premium-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Loading skeleton animation */
        .lm-skeleton {
            background: linear-gradient(90deg, #e5e5e5 25%, #f0f0f0 50%, #e5e5e5 75%);
            background-size: 200% 100%;
            animation: lm-shimmer 1.5s infinite;
        }
        
        @keyframes lm-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .lm-skeleton-image {
            width: 100%;
            height: 192px;
            aspect-ratio: 1;
        }
        
        .lm-skeleton-title {
            height: 24px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .lm-skeleton-date {
            height: 16px;
            width: 80px;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        
        .lm-skeleton-description {
            height: 16px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .lm-skeleton-description.short {
            width: 60%;
        }
        
        .lm-skeleton-button {
            height: 44px;
            width: 128px;
            border-radius: 8px;
            margin-top: auto;
        }
        
        .lm-error {
            text-align: center;
            padding: 80px 20px;
        }
        
        .lm-error-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .lm-error-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .lm-hidden {
            display: none !important;
        }
        
        .lm-visible {
            display: grid !important;
        }
        
        .lm-visible-block {
            display: block !important;
        }
    </style>
</head>
<body>
    <div id="latinometrics-articles" class="lm-container" role="region" aria-label="Latest Articles">
        <!-- Loading State -->
        <div id="lm-loading-state" class="lm-grid lm-visible">
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
            <div class="lm-card">
                <div class="lm-skeleton lm-skeleton-image"></div>
                <div class="lm-content">
                    <div class="lm-skeleton lm-skeleton-title"></div>
                    <div class="lm-skeleton lm-skeleton-date"></div>
                    <div class="lm-skeleton lm-skeleton-description"></div>
                    <div class="lm-skeleton lm-skeleton-description short"></div>
                    <div class="lm-skeleton lm-skeleton-button"></div>
                </div>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="lm-error-state" class="lm-error lm-hidden">
            <div class="lm-error-icon">📰</div>
            <div class="lm-error-message">Unable to load articles at this time</div>
            <button class="lm-button" onclick="window.lmLoadArticles && window.lmLoadArticles()">Try Again</button>
        </div>
        
        <!-- Articles Container -->
        <div id="lm-articles-container" class="lm-grid lm-hidden"></div>
    </div>

    <script>
        // Carrd-Optimized RSS Widget
        (function() {
            'use strict';
            
            // Configuration
            var CONFIG = {
                apiUrl: 'https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Frss.beehiiv.com%2Ffeeds%2Fon4ViAZgs5.xml',
                cacheKey: 'latinometrics_rss_cache',
                cacheDuration: 30 * 60 * 1000, // 30 minutes
                maxArticles: 6,
                maxDescriptionLength: 120,
                timeout: 10000 // 10 second timeout
            };
            
            // DOM Elements
            var elements = {
                loadingState: document.getElementById('lm-loading-state'),
                errorState: document.getElementById('lm-error-state'),
                articlesContainer: document.getElementById('lm-articles-container')
            };
            
            // Utility Functions
            function formatDate(dateString) {
                try {
                    var date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                } catch (e) {
                    return 'Recent';
                }
            }
            
            function truncateText(text, maxLength) {
                if (!text || text.length <= maxLength) return text;
                return text.substring(0, maxLength).trim() + '...';
            }
            
            function getCachedData() {
                try {
                    var cached = localStorage.getItem(CONFIG.cacheKey);
                    if (!cached) return null;
                    
                    var data = JSON.parse(cached);
                    var now = Date.now();
                    
                    if (now - data.timestamp < CONFIG.cacheDuration) {
                        return data.data;
                    }
                    
                    localStorage.removeItem(CONFIG.cacheKey);
                    return null;
                } catch (error) {
                    console.warn('Cache read error:', error);
                    return null;
                }
            }
            
            function setCachedData(data) {
                try {
                    var cacheData = {
                        data: data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(CONFIG.cacheKey, JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Cache write error:', error);
                }
            }
            
            function showLoading() {
                if (elements.loadingState) elements.loadingState.className = 'lm-grid lm-visible';
                if (elements.errorState) elements.errorState.className = 'lm-error lm-hidden';
                if (elements.articlesContainer) elements.articlesContainer.className = 'lm-grid lm-hidden';
            }
            
            function showError() {
                if (elements.loadingState) elements.loadingState.className = 'lm-grid lm-hidden';
                if (elements.errorState) elements.errorState.className = 'lm-error lm-visible-block';
                if (elements.articlesContainer) elements.articlesContainer.className = 'lm-grid lm-hidden';
            }
            
            function showArticles() {
                if (elements.loadingState) elements.loadingState.className = 'lm-grid lm-hidden';
                if (elements.errorState) elements.errorState.className = 'lm-error lm-hidden';
                if (elements.articlesContainer) elements.articlesContainer.className = 'lm-grid lm-visible';
            }
            
            function createArticleCard(article) {
                var card = document.createElement('article');
                card.className = 'lm-card';
                card.setAttribute('role', 'article');

                // Determine the best image to use
                var imageUrl = null;
                var isPremiumContent = false;
                
                // Check if it's a Domingo Brief article (has enclosure image)
                if (article.enclosure && article.enclosure.link) {
                    imageUrl = article.enclosure.link;
                } else if (article.thumbnail) {
                    // Check if this is a generic image (paywalled content)
                    var genericImagePatterns = [
                        /Domingo_Brief_Cover\.png/,
                        /\/image\.png\?/
                    ];
                    var isGenericImage = genericImagePatterns.some(function(pattern) {
                        return pattern.test(article.thumbnail);
                    });
                    
                    if (isGenericImage) {
                        isPremiumContent = true;
                        imageUrl = null;
                    } else {
                        imageUrl = article.thumbnail;
                    }
                }
                
                // Fallback image
                var fallbackImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjE2MCIgeT0iOTAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2Ugbm90IGF2YWlsYWJsZTwvdGV4dD4KPC9zdmc+';

                if (isPremiumContent) {
                    // Create premium content overlay
                    var premiumOverlay = document.createElement('div');
                    premiumOverlay.className = 'lm-premium-overlay';
                    
                    var premiumContent = document.createElement('div');
                    premiumContent.className = 'lm-premium-content';
                    
                    var premiumIcon = document.createElement('div');
                    premiumIcon.className = 'lm-premium-icon';
                    premiumIcon.innerHTML = '🔒';
                    
                    var premiumTitle = document.createElement('h3');
                    premiumTitle.className = 'lm-premium-title';
                    premiumTitle.textContent = 'Premium Content';
                    
                    var premiumSubtitle = document.createElement('p');
                    premiumSubtitle.className = 'lm-premium-subtitle';
                    premiumSubtitle.textContent = 'Unlock exclusive charts & insights';
                    
                    premiumContent.appendChild(premiumIcon);
                    premiumContent.appendChild(premiumTitle);
                    premiumContent.appendChild(premiumSubtitle);
                    premiumOverlay.appendChild(premiumContent);
                    card.appendChild(premiumOverlay);
                } else {
                    // Regular image
                    var thumbnail = document.createElement('img');
                    thumbnail.className = 'lm-image';
                    thumbnail.src = imageUrl || fallbackImage;
                    thumbnail.alt = article.title || 'Article thumbnail';
                    thumbnail.loading = 'lazy';
                    card.appendChild(thumbnail);
                }

                var content = document.createElement('div');
                content.className = 'lm-content';

                var title = document.createElement('h3');
                title.className = 'lm-title';
                title.textContent = article.title || 'Untitled Article';

                var date = document.createElement('p');
                date.className = 'lm-date';
                date.textContent = formatDate(article.pubDate);

                var description = document.createElement('p');
                description.className = 'lm-description';
                description.textContent = truncateText(article.description, CONFIG.maxDescriptionLength);

                // Different button for premium content
                var readMoreBtn = document.createElement('a');
                if (isPremiumContent) {
                    readMoreBtn.className = 'lm-button';
                    readMoreBtn.textContent = 'Subscribe to Read';
                    readMoreBtn.href = 'https://mail.latinometrics.com/upgrade';
                } else {
                    readMoreBtn.className = 'lm-button';
                    readMoreBtn.textContent = 'Read More';
                    readMoreBtn.href = article.link || '#';
                }
                readMoreBtn.target = '_blank';
                readMoreBtn.rel = 'noopener noreferrer';
                readMoreBtn.setAttribute('aria-label', isPremiumContent ? 'Subscribe to read premium content' : 'Read full article: ' + article.title);

                content.appendChild(title);
                content.appendChild(date);
                content.appendChild(description);
                content.appendChild(readMoreBtn);

                card.appendChild(content);

                return card;
            }
            
            function renderArticles(articles) {
                if (!elements.articlesContainer) return;
                
                elements.articlesContainer.innerHTML = '';
                
                var limitedArticles = articles.slice(0, CONFIG.maxArticles);
                
                limitedArticles.forEach(function(article) {
                    var card = createArticleCard(article);
                    elements.articlesContainer.appendChild(card);
                });
                
                showArticles();
            }
            
            function fetchArticles() {
                return new Promise(function(resolve, reject) {
                    var timeoutId = setTimeout(function() {
                        reject(new Error('Request timeout'));
                    }, CONFIG.timeout);
                    
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', CONFIG.apiUrl, true);
                    xhr.timeout = CONFIG.timeout;
                    
                    xhr.onload = function() {
                        clearTimeout(timeoutId);
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                if (data.status === 'ok' && data.items) {
                                    resolve(data.items);
                                } else {
                                    reject(new Error('Invalid API response'));
                                }
                            } catch (e) {
                                reject(new Error('JSON parse error'));
                            }
                        } else {
                            reject(new Error('HTTP error: ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = function() {
                        clearTimeout(timeoutId);
                        reject(new Error('Network error'));
                    };
                    
                    xhr.ontimeout = function() {
                        clearTimeout(timeoutId);
                        reject(new Error('Request timeout'));
                    };
                    
                    xhr.send();
                });
            }
            
            function loadArticles() {
                showLoading();
                
                // Check cache first
                var articles = getCachedData();
                
                if (articles) {
                    renderArticles(articles);
                    return;
                }
                
                // Fetch from API
                fetchArticles()
                    .then(function(articles) {
                        setCachedData(articles);
                        renderArticles(articles);
                    })
                    .catch(function(error) {
                        console.error('Failed to load articles:', error);
                        showError();
                    });
            }
            
            // Initialize widget
            function init() {
                // Add global function for retry button
                window.lmLoadArticles = loadArticles;
                
                // Load articles on page load
                loadArticles();
            }
            
            // Start the widget when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html> 